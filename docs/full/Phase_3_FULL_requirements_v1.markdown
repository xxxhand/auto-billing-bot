# 自動扣款機器人階段需求說明書 - Phase 3: Full Release (V1)

## 概述
**階段目標**：添加進階管理與擴充性，實現完整產品功能。加入檔期優惠、多平台支付、API 與文件化。簡化合規為基本加密，聚焦商業運營。

**依賴**：Phase 1 & 2 功能（POC 和 MVP 階段）。  
**輸出**：完整 V1 產品，支援進階優惠管理與後台管理。  
**User Stories**：涵蓋營運、客服與工程師需求。

---

## 主題：優惠與方案
- **優惠方案設計**：支援固定金額折扣與檔期優惠（特定日期範圍），優先級比較（檔期 > 續訂 > 基本）。  
- **多重優惠疊加**：以優先級處理。若優先級相同，則套用計算後金額較高者。  
- **優惠類型**：完全支援百分比折扣與固定金額折扣並存，與 MVP 的百分比折扣功能相容。  
- **優惠有效期**：每種優惠需明確定義開始與結束時間，儲存於優惠資料結構（如 `valid_from`, `valid_until`），使用 `date-fns` 進行時間驗證。  
- **優惠碼機制**：支援一碼一人使用（單次限定），設定次數上限（如 `usage_limit`）。  
- **第二次以上續訂優惠**：依產品設定，與檔期/優惠碼比較優先級。  
- **方案轉換時的優惠處理**：下期原價計費，套用優惠碼；續訂優惠從第二次適用，優惠期數承接。

## 主題：方案轉換
- **方案切換支援**：支援多種轉換（月/季/年/週），僅允許短期轉長期（如月轉年、季轉年），不支援長期轉短期（如年轉月）。  
- **計費處理**：轉換時不退款，新方案於下一週期生效。  
- **優惠承接**：剩餘優惠期數依新方案承接，確保與優惠模組一致。

## 主題：退款管理
- **暫時忽略**：退款管理需求將推遲至進階調整階段，沿用 MVP 的現有退款功能。

## 主題：扣款失敗與重試
- **扣款失敗重試**：重試間隔設定為 1 小時，不進入寬限期。最大重試次數為 3 次，重試達 3 次後進入寬限期。  
- **失敗分類**：特定失敗原因（如卡片過期、餘額不足）不進行重試，直接進入寬限期。其他失敗原因（如網路錯誤）按重試規則處理。  
- **寬限期**：寬限期設定為 7 天，與 MVP 的寬限期管理一致。  
- **實現方式**：使用 `@nestjs/schedule` 實現重試定時任務，確保與現有自動扣款邏輯整合。

## 主題：狀態管理與資料紀錄
- **訂閱狀態與生命週期**：完整狀態（含方案異動），流轉整合所有流程（如訂閱創建、扣款、方案轉換）。  
- **扣款歷史與異常記錄**：支援人工介入記錄，記錄格式包含 `operator_id`, `action`, `timestamp`，與 MVP 的 `OperationLog` 實體對齊。

## 主題：系統擴充性與彈性
- **策略模式與規則引擎**：扣款、優惠、重試規則可配置，支援產品差異化。  
- **多平台支付支援**：支援多種方式（信用卡、電子支付），預留真實支付網關整合接口（如 Stripe、PayPal）。  
- **人工介入與應急流程**：完整流程，包括異常處理（如手動觸發扣款或修改優惠）。

## 主題：API 與資料結構
- **API/資料結構規劃**：設計查詢、狀態變更、續訂次數 API，沿用 MVP 的 RESTful 設計（如 POST `/client_service/api/v1/subscriptions`）。基本資料欄位包含訂閱 ID、產品 ID、用戶 ID 等。  
- **版本控制**：採用 `/v1/` 路徑進行 API 版本控制。  
- **安全性**：支援 JWT 認證，確保 API 安全性。

## 主題：文件化策略
- **文件與管理後台**：使用 Swagger 提供 API 文件化，與 MVP 短期目標一致。後台支援查詢（按時間範圍、訂閱 ID 篩選）與導出紀錄（支援 CSV、JSON 格式）。  
- **運營文件**：提供操作手冊，涵蓋優惠設定、扣款失敗處理等。

---

## User Stories
| Case | As a | I want | So that |
|------|------|--------|---------|
| 11. | 營運人員 | 設定檔期優惠與優先級，並處理多重優惠疊加 | 自動套用正確規則 |
| 12. | 營運人員 | 管理優惠碼次數與模式（一碼一人，設定上限） | 控制推廣效果 |
| 13. | 前端工程師 | 使用 API 整合訂閱狀態與優惠資訊 | 快速開發 |
| 14. | 客服人員 | 後台導出扣款與異常歷史紀錄 | 處理用戶申訴 |
| 15. | 訂閱者 | 轉換訂閱方案（如月轉年） | 靈活調整訂閱計劃 |

---

## 其他需求
- **合規與安全**：實現基本資料加密（如支付資訊使用 AES-256），防止 SQL 注入與 XSS 攻擊。  
- **效能目標**：系統支援 1000 個並發訂閱查詢，使用 MongoDB 索引優化查詢效率。  
- **資料管理**：歷史資料保留 1 年，支援定期清理。