# 自動扣款機器人階段需求說明書 - Phase 2: MVP (Minimum Viable Product)

## 概述
**階段目標**：基於 Phase 1 POC，構建最小可行產品（MVP），新增自動扣款、優惠方案、退款與扣款失敗處理功能，聚焦用戶端體驗與續訂成功率。簡化優惠為基本折扣，忽略檔期優惠、多租戶與進階擴充。

**依賴**：Phase 1 功能（訂閱週期計算、產品管理、狀態管理、模擬支付）。  
**輸出**：最小可行產品，支援早期用戶測試與基本商業運營。  
**User Stories**：擴展至自動扣款、優惠、方案轉換、退款與錯誤處理。

---

## 主題：自動扣款
- **自動扣款觸發**：根據訂閱的 `nextBillingDate`，定時觸發扣款，整合優惠計算（優惠碼或續訂折扣）。
- **扣款結果處理**：記錄扣款結果（成功/失敗），失敗時進入重試流程，成功時更新 `nextBillingDate` 與續訂次數。
- **執行頻率**：每日檢查即將到期的訂閱（`nextBillingDate` 當天），執行自動扣款。

## 主題：優惠與方案
- **優惠方案設計**：支援百分比折扣（如 30% off），設定優先級（續訂優惠 > 優惠碼）。忽略固定金額與檔期優惠。
- **優惠碼機制**：支援一碼多人使用（無次數上限），記錄使用防止重複。自動扣款時檢查優惠碼有效性。
- **第二次以上續訂優惠**：針對第二次及以上續訂，提供簡單折扣，記錄續訂次數。自動扣款優先應用續訂優惠。
- **方案轉換時的優惠處理**：轉換後下期以新方案原價計費，適用續訂優惠（忽略優惠碼）。

## 主題：方案轉換
- **方案切換支援**：支援月轉年，下期生效，不退費。無優惠承接（僅適用新方案的續訂優惠）。

## 主題：退款管理
- **退款條件與流程**：主動取消時全額退款，退款時機依全域設定（忽略產品優先）。

## 主題：扣款失敗與重試
- **扣款失敗重試與寬限期**：分類失敗原因（網路錯誤、餘額不足），固定 3 次重試（自動扣款觸發），寬限期內支援手動補款。無延後重試。

## 主題：狀態管理與資料紀錄
- **訂閱狀態與生命週期**：擴展 Phase 1，新增寬限期（`grace_period`）、退款中（`refunding`）狀態，整合自動扣款、失敗與取消的流轉規則。
- **扣款歷史與異常記錄**：記錄自動扣款、重試與手動補款的歷史。

---

## User Stories
| Case | As a | I want | So that |
|------|------|--------|---------|
| 5. | 新用戶 | 使用優惠碼獲得折扣 | 我能以低成本開始 |
| 6. | 長期訂閱用戶 | 第二次續訂享有折扣 | 我願意繼續訂閱 |
| 7. | 訂閱用戶 | 轉換方案而不退費 | 我能升級方案 |
| 8. | 訂閱用戶 | 主動取消時退款 | 我有購買保障 |
| 9. | 系統管理者 | 依失敗原因重試扣款 | 提升續訂成功率 |
| 10. | 客服人員 | 查詢擴展狀態與重試歷史 | 快速協助申訴 |
| 11. | 訂閱用戶 | 系統自動按週期扣款 | 我無需手動續訂 |